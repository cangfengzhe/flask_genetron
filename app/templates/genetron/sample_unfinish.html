{% extends "genetron/base.html" %}

{% block head %}
{{ super() }}

<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.common.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.rtl.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.bootstrap.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.dataviz.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.dataviz.bootstrap.min.css')}}" rel="stylesheet">
<script type="text/javascript" src="{{ url_for('static', filename='datatable/js/jquery.js') }}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/jszip.min.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/kendo.all.min.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/console.js')}}"></script>

{% endblock %}

{% block content %}

<style>
      html,
      body,
      #parent
      {
        margin: 0;
        padding: 0;
        border-width: 0;
        height: 100%; /* DO NOT USE !important for setting the Grid height! */
      }

      html
      {
        overflow: hidden;
        font: 13px sans-serif;
      }

       #grid
      {
        margin: 0;
        padding: 0;
        border-width: 0;
        height: 80%; /* DO NOT USE !important for setting the Grid height! */
      }
    
    .problem{
     background-color: #FFC0A9;
    }
    
    .finish{
     background-color: #BEEB9F;
    }
    
    tr.problem:hover{
     background-color: #FF8598;
    }
    
 tr.finish:hover{
     background-color: #A1E29F;  
    }
    #grid .k-grid-toolbar
                {
                  padding: .6em 1.3em;
                }
                .category-label
                {
                    vertical-align: middle;
                    padding-right: .5em;
                }
                #search
                {
                    vertical-align: middle;
                }
                .toolbar {
                    float: right;
                }


</style>

<div id='parent'>
    <div class="alert alert-warning" role="alert">注：绿色表示生信分析完成，交由报告组处理；红色表示问题样本（质控不合格、配对问题...）。目前，panel51、CT_DNA样本统计不全</div>
    <div id="grid"></div>
</div>
 <script type="text/x-kendo-template" id="template">

                <div class="toolbar">
                    <label class="category-label" for="category">Search:</label>
                    <input type="search" id="search" style="width: 150px"/>
                </div>
 </script>


<script>
                    var gridElement = $("#grid");
                    $("#grid").kendoGrid({
                         toolbar: ["excel",
                                 
                                    {
                               template:kendo.template($("#template").html()),
                                    }
                                 ],
                        excel: {
                            allPages: true
                            },
                        dataSource: {
                            transport: {
                                read:  {
                                url: "/api/sample_flowcell",
                                dataType: "json" // "jsonp" is required for cross-domain requests; use "json" for same-domain requests
                                },
                            
                                update: {
                                    url: '/api/sample_flowcell',
                                    type: 'post',
                                    dataType: "json",
                                },
                                destroy: {
                                    url: '/api/sample_flowcell',
                                    dataType: "json",
                                    type: 'delete'
                                },
                            parameterMap: function(data, operation) {
//                                 if (operation === "update" || operation === "create") {
//                                     data.start_time = kendo.toString(kendo.parseDate(data.start_time), "s");
//                                     if (data.end_time != ''){
//                                         data.end_time = kendo.toString(kendo.parseDate(data.end_time), "s");
//                                     }
                                    
//                                 }
                                return data;
                            }
                           
                            },
                            batch: false,
                            autoSync: true,
                            schema: {
                                type: 'json',
                                data: "data",
                                total: function(data) {
                                    return data.data.length;

                            },
                            model: {
                                id:'id',
                                 fields: {
                                    sample_id: { type: "string" , editable: false},
                                    flowcell: {type: "string", editable: false,},
                                     name: { type: "string",editable: false },
                                     hospital: { type: "string", editable: false},
                                     panel: { type: "string" , editable: false},
                                     //blts: { type: "string" },
                                     tumor: { type: "string" , editable: false},
                                     tissue: { type: "string", editable: false },
                                     //collect_time: { type: "date" },
                                     //accept_time: { type: "date" },
                                     class_time: { type: "date" , editable: false},
                                     submit_time: { type: "date", editable: false },
                                     bioinfo_finish_time: { type: "date", editable: false },
                                     bioinfo_report_time: { type: "date", editable: false },
                                     //ask_histology_time: { type: "date" },
                                     is_problem: { type: "boolean", editable: true },
                                     finish: { type: "boolean", editable: true },
                                     is_finish_time: { type: "date", editable: false },
                                     end_time: { type: "date", editable: false },
                                     xj_time: { type: "date", editable: false },
                                     note: { type: "string", editable: false },
                                     
                                    }
                                }
                            },
                            sort: {
                                field: "class_time",
                                dir: "desc"
                            },
                            pageSize: 20,
                        },
                        dataBound: function () {
                            dataView = this.dataSource.view();
                            for(var i = 0; i < dataView.length; i++) {
                                if(dataView[i].bioinfo_finish === true) {
                                   var uid = dataView[i].uid;
                                   $("#grid tbody").find("tr[data-uid=" + uid + "]").addClass("finish");
                                 }
                                
                                if(dataView[i].is_problem === true) {
                                   var uid = dataView[i].uid;
                                   $("#grid tbody").find("tr[data-uid=" + uid + "]").addClass("problem");
                                 }
                            }
                            
                             if (this.dataSource.totalPages() <= 1) {
                              this.pager.element.hide();
                             }
                        },
                        
                        scrollable: true,
                        pageable: true,
                        sortable:true,
                        editable: "inline",
                        autoSync: true,
                        filterable:true,
                        columns: [
                        { command: ["edit","destroy"], title: "&nbsp;", width: "200px" },
                            {
                                field:"sample_id",
                                title: "ID",
                                width: 100,
                                filterable: true,
                                template: '<a href=\'{{url_for("genetron.sample_info")}}?id=#=sample_id#\'  target="_blank">#=sample_id#</a>'
                            },
                             {
                                 field:"flowcell",
                                 title: "Run_ID",
                                 width: 100,
                                 editable:false,
                                 
                             },
                            {
                                field:"panel",
                                title: "panel",
                                width: 120,
                            },
                            {
                                field:"hospital",
                                title: "医院",
                                width: 120,
                            },
                            {
                                field:"is_problem",
                                title: "问题样本",
                                width: 80,
                                template: '#= is_problem == true ? "是" : "否" #',
                                
                            },
                            {
                                 field:"tissue",
                                 title: "组织",
                                 width: 200,
                             },
                           
                             {
                                 field:"tumor",
                                 title: "癌种",
                                 width: 200,

                             },
                             

                            {
                                field:"xj_time",
                                title: "下机时间",
                                width: 160,
                                format: "{0:yyyy-MM-dd HH:mm:ss}",
                            },
                            {
                                field:"class_time",
                                title: "分类时间",
                                width: 160,
                                format: "{0:yyyy-MM-dd HH:mm:ss}",

                            },
                            {
                                field:"submit_time",
                                title: "提交时间",
                                width: 160,
                                format: "{0:yyyy-MM-dd HH:mm:ss}",

                            },
                            {
                                field: "bioinfo_finish_time",
                                title: "生信完成时间",
                                width: 160,
                                format: "{0:yyyy-MM-dd HH:mm:ss}",

                            },
                            {
                                field: "bioinfo_report_time",
                                title: "生信报告时间",
                                width: 160,
                                format: "{0:yyyy-MM-dd HH:mm:ss}",

                            }, 
                             {
                                field: "note",
                                title: "备注",
                                width: 130,
                            },
                           
                       ],
                    }); 
$("#search").keyup(function () {
    var val = $('#search').val();
    gridElement.data("kendoGrid").dataSource.filter({
        logic  : "or",
        filters: [
            {
                field   : "sample_id",
                operator: "contains",
                value   : val
            },
            {
                field   : "panel",
                operator: "contains",
                value   : val
            }
        ]
    });
});



</script>

{% endblock %}

{% block scripts %}
{% endblock %}
