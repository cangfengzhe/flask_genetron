{% extends "genetron/base.html" %}

{% block content %}
<link rel="stylesheet" type="text/css" href="//cdn.jsdelivr.net/bootstrap.daterangepicker/2/daterangepicker.css" />
<style>
    table#check_table .short{
        width:`60%;
    }
   
     table#check_table .long{
        width:150px;
    }
    table#check_table .daterange{
        width:150px;
    }
    table#check_table {
   text-align: center;   
}
    </style>
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading">
                    患者基本信息
                </div>
                {% if sample.patient != None %}
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <td>患者信息: {{sample.patient.name}}</td>
                            <td>患者编号: {{sample.patient.patient_id}}</td>
                        </tr>
                        <tr>
                            <td>性别:{% if sample.patient.sex == 1 %}
                                男
                                {% else %}
                                女
                                {% endif %}
                            </td>
                            <td>年龄: {{sample.patient.age}}</td>
                        </tr>
                        <tr>
                            <td>既往诊断结果: {{sample.indication}}</td>
                            <td>既往治疗方案:</td>
                        </tr>
                        <tr>
                            <td>靶向药物服用史:</td>
                            <td>癌症家族史:</td>
                        </tr>

                    </table>
                </div>


            </div>
            {% endif %}
            <!-- /.panel -->
        </div>
    </div>


    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading">
                    样本基本信息
                </div>
                {% if sample.patient != None %}
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <td>肿瘤样本类型: {{sample.tumor_type}}</td>
                            <td>肿瘤样本采集部位: {{sample.tumor_pos}}</td>
                        </tr>
                        <tr>
                            <td>肿瘤采集日期: {{ sample.collect_time|datetimeformat("%Y-%m-%d %H:%M:%S") }}
                            </td>
                            <td>肿瘤样本接受日期: {{ sample.accept_time|datetimeformat("%Y-%m-%d %H:%M:%S") }}</td>
                        </tr>
                        <tr>


                    </table>
                </div>


            </div>
            {% endif %}
            <!-- /.panel -->
        </div>
    </div>


    <!-- time -->

    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading">
                    生物信息分析
                </div>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th>Flowcell_ID</th>
                            <th>Panel</th>
                            <th>下机时间</th>
                            <th>拆分时间</th>
                            <th>分类时间</th>
                            <th>提交时间</th>
                            <th>生信完成时间</th>
                            <th>生信报告时间</th>

                        </tr>
                        {% set flowcell_list=[] %}
                        {% for flowcell_index in sample.sample_flowcell.all() %}

                        <tr>
                            <td>{{ flowcell_index.flowcell.flowcell_id }}</td>
                            <td>{{ flowcell_index.panel }}</td>
                            <td>{{ flowcell_index.flowcell.xj_time|datetimeformat("%Y-%m-%d %H:%M:%S") }}</td>

                            <td>{{ flowcell_index.flowcell.cf_time|datetimeformat("%Y-%m-%d %H:%M:%S") }}</td>

                            <td>{{flowcell_index|get_item_time('class')}}</td>
                            <td>{{flowcell_index|get_item_time('submit')}}</td>
                            <td>{{flowcell_index|get_item_time('bioinfo_finish')}}</td>
                            <td>
                                {{flowcell_index|get_item_time('bioinfo_report')}}
                            </td>
                            <!--                                      <td>{{ flowcell_index.sample_time.filter_by(item_type='bioinfo_report').first().item_time|datetimeformat("%Y-%m-%d %H:%M:%S") if flowcell_index.sample_time.filter_by(item_type='bioinfo_report').first() != None}} </td> -->

                        </tr>
                         {% if flowcell_list.append( (flowcell_index.flowcell.flowcell_id, flowcell_index.panel) )  %} {% endif %}
                      
                        {% endfor %}

                    </table>
                </div>


            </div>
            <!-- /.panel -->
        </div>
    </div>

    <!-- check -->
    <script>
   
    
    
    
  
        
        
    </script>
    
    


    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading">
                    实验验证
                </div>
                
                <div class="panel-body">
                     <button class='btn btn-success' id='check_add'>Add</button>
                    <table class="table table-condensed" id='check_table' align="center">
                        <tr>
                            <th class="text-center short" >Flowcell</th>
                            <th class="text-center short">Panel</th>
                            <th class="text-center short">验证项目</th>
                            <th class="text-center short">验证基因</th>
                            <th class="text-center">申请时间</th>
                            <th class="text-center">反馈时间</th>
                            <th class="text-center">结果</th>
                            <th class="text-center">备注</th>

                        </tr>                       

                    </table>
                </div>


            </div>
            <!-- /.panel -->
        </div>
    </div>
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">
            <div class="panel panel-info">
                <div class="panel-heading">
                    医学信息解读
                </div>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th>报告初稿</th>
                            <th>报告完成时间</th>
                            <th>报告审核</th>
                            <th>报告审核时间</th>
                            <th>报告最终完成时间</th>

                        </tr>
                        {% for flowcell_index in sample.sample_flowcell.all() %}

                        <tr>
                            <td></td>
                            <td></td>
                            <td></td>

                            <td></td>

                            <td></td>

                        </tr>
                        {% endfor %}

                    </table>
                </div>


            </div>
            <!-- /.panel -->


        </div>
    </div>

    
    <div class="row">
        <div class="col-lg-10 col-lg-offset-1">

            <div class="panel panel-info">
                <div class="panel-heading">
                    医学信息解读
                </div>
                <div class="panel-body">
                    <table class="table table-condensed">
                        <tr>
                            <th >报告初稿</th>
                            <th>报告完成时间</th>
                            <th>报告审核</th>
                            <th>报告审核时间</th>
                            <th>报告最终完成时间</th>

                        </tr>

                        <tr>
                            <td>


                            </td>
                            <td>


                            </td>
                            <td></td>

                            <td></td>

                            <td></td>

                        </tr>
<tr>
      <td>

                            </td>
    <td></td>
</tr>
                    </table>
                </div>


            </div>
            <!-- /.panel -->


        </div>
    </div>


</div>
<script type="text/javascript" src="{{ url_for('static', filename='datatable/js/jquery.js') }}"></script>

<script type="text/javascript" src="{{ url_for('static', filename='bootstrap/js/bootstrap.min.js') }}"></script>
<script src="/admin/static/vendor/moment.min.js?v=2.9.0" type="text/javascript"></script>
<script src="/admin/static/vendor/select2/select2.min.js?v=3.5.2" type="text/javascript"></script>
<script src="/admin/static/vendor/bootstrap-daterangepicker/daterangepicker.js?v=1.3.22"></script>
<script>
$(document).ready(function(){

    $('#btn_reporter').click(function(){
    var select_value =  $("#select_reporter").val();

$.ajax({
    url:'{{ url_for("genetron.report_user") }}',
    type:'GET', //GET
    async:true,    //或false,是否异步
    data:{
        report:'yang',
        check:25
    },
    timeout:5000,    //超时时间
    dataType:'json',    //返回的数据格式：json/xml/html/script/jsonp/text
    beforeSend:function(xhr){
        console.log(xhr)
        console.log('发送前')
    },
    success:function(data,textStatus,jqXHR){
        console.log(data)
        console.log(textStatus)
        console.log(jqXHR)
    },

    complete:function(){
        console.log('结束')
    }
})
    })

   // check table
    $("button#check_add").click(function(){
        
        var tr = 
          
            '<tr>' + 
             
                            '<td><input  type="text" class="short form-control"  name="flowcell" value= "{{flowcell_list[0][0] if flowcell_list }}"/></td>' + 
                            '<td><input  type="text" class="short form-control"  name="panel" value= "{{flowcell_list[0][1] if flowcell_list }}"/></td>' + 

                            '<td><input  type="text" class="short form-control"  name="check_type"  /></td>' + 

                           ' <td><input  type="text"  class="short form-control"   name="gene" /></td>' + 
                            '<td><input name="start_time" type="text" value="" class="daterange form-control" name="check_time"></td>' + 
                            '<td><input name="end_time" type="text" value=""  class="daterange form-control" name="result_time"></td>' + 
                            '<td><input name="result" type="text" value=""  class="long form-control" name="result"></td>' + 
                            '<td><input  type="text"  value="" class="long form-control"  name="note"></td>' +
                            '<td><button  class="check btn btn-success form-control" >submit</button></td>' + 
                            '</tr>'               
        
        $('table#check_table').append(tr);
    })
     

    // ajax submit check table
   var submit_data = {}
     $("table#check_table").off('click').on('click','input',function(){
          // console.log($("table#check_table").html())
         
             
                    
          $('button.check').unbind('click').click(function(){
              
               // $("table#check_table tr td").each(function(){
           
              $(this).parent().parent().children().each(function(){
                  dt = $(this).find('input');
                  // submit_data[dt.attr('name')] = dt.val();
                  // console.log(dt.attr('value'))
                  // dt.val('hah')
                  submit_data[dt.attr('name')] = dt.val();
              })
              submit_data['sample'] = {{sample.sample_id  }}
              if (submit_data['check_type'] == ''){
                  
                  alert('验证类型不能为空')
                  return 0;
              }
              if (submit_data['start_time'] == ''){
                  
                  alert('开始时间不能为空')
                  return 0;
              }
               console.log(submit_data)
               $.ajax({
                  type: 'POST',
                  url: '{{ url_for("genetron.check_info") }}',
                  data: submit_data,
                  success: function(data){
                   console.log(data) 
                   alert(data)
                   }
                  
                });
               // console.log('lipidong')
              // $("table#check_table").off('click'）
          })
          
     })
   

//     $.ajax({
//     url:'{{ url_for("genetron.check_info") }}',
//     type:'GET', //GET
//     async:true,    //或false,是否异步
//     data:'',
//     timeout:5000,    //超时时间
//     dataType:'json',    //返回的数据格式：json/xml/html/script/jsonp/text
//     beforeSend:function(xhr){
//         console.log(xhr)
//         console.log('发送前')
//     },
//     success:function(data,textStatus,jqXHR){
//         console.log(data)
//         console.log(textStatus)
//         console.log(jqXHR)
//     },

//     complete:function(){
//         console.log('结束')
//     }
// })

    
    
    //bubble
    $(".example")
        .popover({ title: 'Edit', 
                  html: true,
                  content: " <label>" +  $(this).id +":</label> <input id='popover_input' type='text' class='daterange' /> <button id='popover_enter'>Enter</button><button id='popover_cancle'>Cancel</button>"
                 })
    .on('click', function(){
        $('input.daterange').daterangepicker({
            timePicker: true,
            singleDatePicker: true,
            "showWeekNumbers": true,
            showDropdowns: true,
            timePickerIncrement: 1,
            timePicker12Hour: false,
            format:"YYYY-MM-DD HH:mm",
            locale: {
                
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",

            },
           
      });
        $('#popover_cancle').click(function(){
           $('.example').popover('hide'); 
        });
        
        $('#popover_enter').click(function(){
          $('.example').text( $('#popover_input').val() )
          $('.example').popover('hide'); 
        })
    })

 $("table#check_table").on('focus','input.daterange',function(){
          $('input.daterange').daterangepicker({
            timePicker: true,
            singleDatePicker: true,
            "showWeekNumbers": true,
            showDropdowns: true,
            timePickerIncrement: 1,
            timePicker12Hour: false,
            format:"YYYY-MM-DD HH:mm",
            locale: {
                
                "applyLabel": "Apply",
                "cancelLabel": "Cancel",

            },
           
      });
     });
    

    
});

</script>



{% endblock %}

{% block scripts %}
{{supper}}


{% endblock %}