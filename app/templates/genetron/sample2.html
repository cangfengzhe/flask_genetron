{% extends "genetron/base.html" %}

{% block head %}
{{ super() }}

<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.common.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.rtl.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.bootstrap.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.dataviz.min.css') }}" rel="stylesheet">
<link href="{{ url_for('static', filename='kendo_ui/styles/kendo.dataviz.bootstrap.min.css')}}" rel="stylesheet">

<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/jszip.min.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/kendo.all.min.js')}}"></script>
<script type="text/javascript" src="{{ url_for('static', filename='kendo_ui/js/console.js')}}"></script>

{% endblock %}

{% block content %}

<style>
      html,
      body,
      #parent,
      #grid
      {
        margin: 0;
        padding: 0;
        border-width: 0;
        height: 100%; /* DO NOT USE !important for setting the Grid height! */
      }

      html
      {
        overflow: hidden;
        font: 13px sans-serif;
      }

#grid{
 height:90%;
}

 #grid .k-grid-toolbar
                {
                    padding: .6em 1.3em;
                }
                .category-label
                {
                    vertical-align: middle;
                    padding-right: .5em;
                }
                #search
                {
                    vertical-align: middle;
                }
                .toolbar {
                    float: right;
                }
    </style>

 <div id='parent'>
     <div id="grid"></div> 
</div>

 <script type="text/x-kendo-template" id="template">

                <div class="toolbar">
                    <label class="category-label" for="category">Search:</label>
                    <input type="search" id="search" style="width: 150px"/>
                </div>
 </script>

<script>

var gridElement = $("#grid");


      function resizeGrid() {
        gridElement.data("kendoGrid").resize();
      }

    function toolbar_click() {
        var samples =  $("#grid").data("kendoGrid");
        grid.dataItems()

          return false;
}
    
     function TissueDropDownEditor(container, options) {
                     $('<input name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoComboBox({
                            autoBind: false,
                            dataTextField: "text",
                            dataValueField: "value",
                            dataSource: {
                                type: "json",
                                transport: {
                                    read: "/api/tissue"
                                },
                            },
                        filter: "contains",
                         suggest: true,
                         change: function (e) {
                              if (this.selectedIndex == -1) {
                                 this.value(" ");                            
                              }
                         }   
                        });
                }
    
    
     function TumorDropDownEditor(container, options) {
                    $('<input  name="' + options.field + '"/>')
                        .appendTo(container)
                        .kendoComboBox({
                            autoBind: false,
                            dataTextField: "text",
                            dataValueField: "value",
                            dataSource: {
                                type: "json",
                                transport: {
                                    type: "json",
                                    read: "/api/tumor/"
                                },
                            },
                         filter: "contains",
                         suggest: true,
                         change: function (e) {
                              if (this.selectedIndex == -1) {
                                 this.value(" ");                            
                              }
                         }   
                        });
                }
    function TextareaEditor(container, options) {
                    $('<textarea rows="3" cols="25"  name="' + options.field + '"/>')
                        .appendTo(container)
                        
                }

    
 $(window).resize(function(){
        resizeGrid();
      });
                    $("#grid").kendoGrid({
                        toolbar: [
                                    {
                               template:kendo.template($("#template").html()),
                                    }
                                 ],
                        dataSource: {
                            transport: {
                                read:  {
                                url: "{{ url_for('genetron.sample_table') }}",
                                dataType: "json" // "jsonp" is required for cross-domain requests; use "json" for same-domain requests
                                },
                                 update: {
                                    url: '/api/sample/',
                                    type: 'post',
                                    dataType: "json",
                                },
                            
                            },
                            batch: false,
                            autoSync: true,
                            schema: {
                                type: 'json',
                                data: "data",
                                total: function(data) {
                                    return data.data.length;
                            },
                            model: {
                                 id:'id',
                                 fields: {
                                     sample_id: { type: "string",  editable: false },
                                     name: { type: "string", editable: false },
                                     hospital_alias: { type: "string" , editable: false},
                                     panel: { type: "string", editable: false },
                                     indication: { type: "string" },
                                     tumor: { type: "string", nullable:true, validation: { required: false }  },
                                     tissue: { type: "string", nullable:true, validation: { required: false } },
                                     ask_histology: {type: 'boolean'},
                                     note_info: { type: "string" },
                                     accept_time: {type: 'date'}
                                    },
                               
                                }
                            },
                            sort: {
                                field: "accept_time",
                                dir: "desc"
                            },
                            pageSize: 20,

                        },
                        scrollable: true,
                        filterable: {
                            extra: false,
                            operators: {
                                string: {
                                   // startswith: "Starts with",
                                   // eq: "Is equal to",
                                    neq: "Is not equal to"
                                }
                            }
                        },
                        filterable:true,
                        sortable:true,
                        pageable: true,
                        {% if current_user.is_reporter() %}
                        editable: true,
                        {% endif %}
                                         
                        columns: [
                            {
                                field:"sample_id",
                                title: "ID",
                                width: 100,
                                filterable: true,
                                template: '<a href=\'{{url_for("genetron.sample_info")}}?id=#=sample_id#\'  target="_blank">#=sample_id#</a>',
                                editable:false,
                            },
                            {
                                field:"name",
                                title: "姓名",
                                width: 80,
                                filterable: true,

                            },
                            {
                                field:"panel",
                                title: "panel",
                                width: 80,
                                filterable: true,
                            },
                                         {
                                field:"hospital_alias",
                                title: "医院",
                                width: 100,
                                filterable: true
                            },
                            {
                                field:"indication",
                                title: "病理提示",
                                width: 300,
                                filterable: true,
                                editor:TextareaEditor
                            },
                                         {
                                field:"tissue",
                                title: "组织",
                                width: 200,
                                filterable: true,
                                editor: TissueDropDownEditor,
                                nullable:true

                            },
                            {
                                field:"tumor",
                                title: "癌种",
                                width: 200,
                                filterable: true,
                                nullable:true,
                                editor: TumorDropDownEditor,
                                // template: "#=tumor.aa#"
                            },
                            
                            
                            {
                                field: "ask_histology",
                                title: "索要病理",
                                width: 80,
                                filterable: true,
                                template: '#= ask_histology == true ? "是" : "否" #',

                            },
                            {
                                field: "note",
                                title: "备注",
                                width: 200,
                                editor: TextareaEditor,

                            },
                            
                       ],
                    });

$("#search").keyup(function () {
    var val = $('#search').val();
    gridElement.data("kendoGrid").dataSource.filter({
        logic  : "or",
        filters: [
            {
                field   : "sample_id",
                operator: "contains",
                value   : val
            },
            {
                field   : "name",
                operator: "contains",
                value   : val
            },
            {
                field   : "panel",
                operator: "contains",
                value   : val
            }
        ]
    });
});
		
            </script>


    {% endblock %}

